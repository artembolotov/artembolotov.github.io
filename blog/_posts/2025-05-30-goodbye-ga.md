---
title: "Переход с Google Analytics на Яндекс.Метрику с соблюдением GDPR"
description: "Практическое руководство по отказу от хорошего инструмента"
tags: [webdev]
image: /blog/img/2025-05-30-goodbye-ga/migrate.png
draft: false
---

![Уходим с GA](/blog/img/2025-05-30-goodbye-ga/migrate.png)

С 1 июля 2024 года вступают в силу изменения в российском законодательстве, которые существенно ограничивают использование сервисов Google Analytics для российских сайтов. В этой статье я расскажу о своем опыте миграции на Яндекс.Метрику и поделюсь практическими советами по правильной настройке счетчика с учетом требований о защите персональных данных.

## Почему нужно переходить?

Новые требования законодательства ограничивают передачу данных российских пользователей в юрисдикции, не обеспечивающие адекватный (по мнению каких-то дяденек) уровень защиты персональных данных. Google Analytics хранит данные на серверах в США, что теперь создает правовые риски для владельцев сайтов.

## Подготовка к миграции

Прежде чем начать, убедитесь что у вас есть:
- Аккаунт в Яндексе
- Доступ к коду вашего сайта
- Понимание текущей структуры аналитики

### Шаг 1: Создание счетчика

1. Зайдите в [Яндекс.Метрику](https://metrika.yandex.ru/){:target="_blank"}
2. Нажмите "Добавить счетчик"
3. Укажите адрес сайта и название
4. Настройте базовые параметры

## Правильная установка с учетом GDPR

Ключевой момент - счетчик должен начинать работу только после явного согласия пользователя. Вот правильный подход:

### HTML разметка

```html
<!-- Yandex.Metrika counter -->
<script type="text/javascript">
   (function(m,e,t,r,i,k,a){
      m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
      m[i].l=1*new Date();
      for (var j = 0; j < document.scripts.length; j++) {
         if (document.scripts[j].src === r) { return; }
      }
      k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
   })(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   // Счетчик будет инициализирован после согласия
   window.yaCounterInit = false;
</script>
<!-- /Yandex.Metrika counter -->
```

### JavaScript логика

```javascript
const initYandexMetrika = function() {
    if (typeof ym !== 'undefined' && !window.yaCounterInit) {
        ym(12345678, "init", {
            clickmap: true,
            trackLinks: true,
            accurateTrackBounce: true,
            webvisor: true
        });
        window.yaCounterInit = true;
    }
}

// Проверяем, давал ли пользователь согласие ранее
if (localStorage.getItem('cookies_accepted')) {
    initYandexMetrika();
} else {
    // Показываем баннер согласия
    document.getElementById('cookie-banner').style.display = 'block';
}

// Обработчик кнопки согласия
document.getElementById('accept-cookies').addEventListener('click', function() {
    localStorage.setItem('cookies_accepted', 'true');
    document.getElementById('cookie-banner').style.display = 'none';
    initYandexMetrika();
});
```
![Баннер](/blog/img/2025-05-30-goodbye-ga/screenlines-banner.png)
*Я просто прибил баннер с согласием к низу экрана*

## Важно: почему мы убрали noscript версию

При установке Яндекс.Метрика предлагает добавить `<noscript>` тег для пользователей с отключенным JavaScript:

```html
<!-- НЕ ИСПОЛЬЗУЙТЕ ЭТО -->
<noscript>
  <div><img src="https://mc.yandex.ru/watch/12345678" style="position:absolute; left:-9999px;" alt="" /></div>
</noscript>
```

**Почему это неправильно:**
- Пользователи без JavaScript не могут дать согласие на сбор данных
- Но данные все равно собираются через картинку
- Это прямое нарушение принципа информированного согласия

## Настройка параметров счетчика

Рекомендуемые настройки для большинства сайтов:

```javascript
ym(12345678, "init", {
    clickmap: true,           // Карта кликов
    trackLinks: true,         // Отслеживание внешних ссылок
    accurateTrackBounce: true,// Точный показатель отказов
    webvisor: false,          // Вебвизор (требует дополнительного согласия)
    ecommerce: "dataLayer"    // Для интернет-магазинов
});
```

## Проблемы при тестировании

При проверке работы счетчика вы можете столкнуться с тем, что данные не поступают в Метрику. Вот основные причины:

### 1. Блокировщики рекламы
Большинство блокировщиков (AdBlock, uBlock Origin) блокируют счетчики аналитики. Для тестирования временно отключите их.

### 2. Проблемы с определением геолокации
Если из-за особенностей маршрутизации трафика ваше устройство определяется как находящееся в другой стране, некоторые функции Метрики могут работать некорректно. Это может происходить при:
- Использовании корпоративных сетей с международной маршрутизацией
- Подключении через спутниковый интернет
- Некорректной настройке DNS-серверов

В таких случаях попробуйте протестировать с другого устройства или сети.

### 3. Режим инкогнито
В приватном режиме браузера localStorage недоступен, что может повлиять на сохранение согласия.

## Проверка корректности установки

1. Откройте консоль разработчика (F12)
2. Перейдите на вкладку Network
3. Обновите страницу
4. После согласия на cookies найдите запросы к `mc.yandex.ru`

## Миграция целей и событий

Если у вас были настроены цели в Google Analytics, их нужно пересоздать в Метрике:

```javascript
// Google Analytics
gtag('event', 'purchase', {
    value: 1000,
    currency: 'RUB'
});

// Яндекс.Метрика
ym(12345678, 'reachGoal', 'purchase', {
    order_price: 1000,
    currency: 'RUB'
});
```

## Чек-лист после миграции

- Удален весь код Google Analytics и GTM
- Установлен код Яндекс.Метрики
- Настроена работа только после согласия
- Удалена noscript версия счетчика
- Проверена работа в разных браузерах
- Обновлена политика конфиденциальности

## Заключение

Переход на Яндекс.Метрику - это не просто смена инструмента аналитики, а важный шаг для соблюдения законодательства. Правильная настройка с учетом требований о согласии пользователя защитит вас от возможных проблем.