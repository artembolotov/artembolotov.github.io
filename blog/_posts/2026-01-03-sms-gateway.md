---
title: "От 50₽ за SMS к собственному шлюзу: история compaund-sms-gateway"
description: "Пишем собственный SMS-шлюз на базе Android-смартфона"
tags: [webdev]
draft: true
---

Мы в [компаунде](https://compaund.com/){:target="_blank"} отправляем клиентам в смс статусы заказов. Отремонтировали ваш телефон, приехало что-то, чего не было в наличии — пришла смс. 
Всё было хорошо, но в какой-то момент заметили, что стоимость одного такого сообщения приблизилась к 50 рублям. При этом они приходят от "INFO" или какого-нибудь "MFISMS".
И вот 400 сообщений в месяц обходятся в 6500-7000 рублей. А могут ещё дороже.

## Золотое время, которое мы потеряли

Давайте перемотаем на несколько лет назад. В 2020-2021 годах отправка SMS через агрегаторов была простой и дешевой: 1.5-2₽ за сообщение, бесплатные имена отправителя, никаких абонентских плат. Для небольшого сервисного центра, который отправляет клиентам уведомления о готовности заказов, это было идеально.

Потом началось интересное.

**1 января 2022** — Мегафон вводит обязательную платную регистрацию имени отправителя. Цена: 2500₽ в месяц.

**4 марта 2022** — МТС блокирует все бесплатные и общие имена отправителя. Теперь только платная регистрация за 2000₽ в месяц. SMS от незарегистрированных имен просто не доставляются.

**2024-2025** — Остальные операторы следуют тренду. Билайн поднимает цены на рекламные SMS до 7.5₽, вводит дифференциацию по типам сообщений.

К концу 2025 года картина выглядела так:
- МТС: 2000-2200₽/мес за имя отправителя
- Мегафон: 2500-2700₽/мес
- Билайн: 1000-1200₽/мес
- Теле2: 1000₽/мес

**Итого**: около 7000₽ в месяц просто за право отправлять SMS от своего имени. И это еще до того, как ты отправил хоть одно сообщение.

## Анатомия абсурда

Но абонентская плата — это только начало. Дальше начинается магия ценообразования.

Операторы разделили все SMS на категории:
- **Авторизационные** (коды подтверждения): 1.5-3₽
- **Сервисные** (уведомления о заказах): 2-4₽
- **Рекламные** (любая маркетинговая информация): 5-8₽

Звучит логично? Подождите, не спешите.

Для доступа к дешевым тарифам нужно:
1. Зарегистрировать имя отправителя у каждого оператора отдельно (и платить за каждое)
2. Создать и согласовать шаблоны сообщений
3. Ждать одобрения 5-7 рабочих дней
4. Молиться, чтобы оператор не отклонил шаблон из-за "рекламного характера"

А если не хочешь проходить этот квест? Тогда добро пожаловать в мир "универсальных тарифов", где одно SMS может стоить **до 50 рублей**. Пятьдесят рублей за одно текстовое сообщение.

При этом:
- Оно придет от случайного отправителя
- Доставка не гарантирована
- Статистику увидишь только в личном кабинете агрегатора
- Клиент не сможет перезвонить или ответить

## Снижмаем расходы

Учитывая такие тарифы, мы перестали отправлять смс, если телефон отремонтировать не удалось. Появилась мысль просто выделить какой-нибудь телефон, с которого отправлять смс вручную. Да, это вообще не удобно, и если какие-то шаблоны ещё можно придумать, то номер из CRM на компьюетере, нужно будет вводить на телефоне вручную.

Тут я и подумал: а что, если?

## Решение: возвращаемся к истокам

Идея была простой до безобразия:
1. Берем старый Android-смартфон, который лежит без дела
2. Вставляем SIM-карту с тарифом "Безлимитные SMS" (Тинькофф Мобайл, 49₽/месяц)
3. Устанавливаем приложение [android-sms-gateway](https://github.com/android-sms-gateway/android-sms-gateway) — открытый проект для отправки SMS через API
4. Пишем свою обертку для интеграции в бизнес-процессы

Звучит слишком просто? Да. Именно поэтому сработало.

## Техническая реализация: compaund-sms-gateway

Android-sms-gateway — это отличная основа, но для продакшена мне нужно было больше:
- Собственная база данных для хранения всей истории
- Система пользователей с разграничением прав
- Шаблоны сообщений для типовых уведомлений
- API, который легко интегрировать в существующие системы
- Отслеживание статусов доставки в реальном времени

### Архитектура

```
Клиент/CRM → compaund-sms-gateway API → android-sms-gateway → Android-устройство → SMS
                        ↓
                  PostgreSQL
            (users, messages, templates)
```

**Основные компоненты:**

**Backend (Node.js + Express):**
- Сервис аутентификации с JWT-токенами
- Сервис управления сообщениями
- Сервис шаблонов
- Интеграция с android-sms-gateway через их API

**База данных (PostgreSQL):**
- `users` — пользователи системы с хешированными паролями (bcrypt)
- `messages` — полная история сообщений с метаданными
- `templates` — шаблоны для частых уведомлений

**Жизненный цикл сообщения:**

1. POST-запрос на `/api/sms/send` с номером и текстом
2. Создание записи в БД со статусом `pending`
3. Отправка в android-sms-gateway
4. Получение external_id от android-sms-gateway
5. Webhook от android-sms-gateway обновляет статус: `sent` → `delivered` или `failed`

### Пример использования

```javascript
// Отправка SMS
POST https://sms.compaund.com/api/sms/send
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "phone": "+79991234567",
  "message": "Ваш iPhone 12 готов к выдаче. Стоимость ремонта: 5000₽. Сервис Compaund, тел. +7(900)123-45-67"
}

// Ответ
{
  "success": true,
  "messageId": 1234,
  "externalId": "abc-123-def",
  "status": "pending"
}
```

```javascript
// Проверка статуса
GET https://sms.compaund.com/api/sms/status/1234
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

// Ответ
{
  "success": true,
  "message": {
    "id": 1234,
    "phone": "+79991234567",
    "status": "delivered",
    "sentAt": "2026-01-03T10:30:00Z",
    "deliveredAt": "2026-01-03T10:30:15Z"
  }
}
```

### Безопасность

JWT с версионированием токенов — изящное решение проблемы инвалидации. Каждый пользователь имеет `token_version` в базе данных. При выходе или компрометации версия увеличивается, и все старые токены автоматически становятся недействительными. Не нужно вести blacklist токенов.

## Результаты: цифры говорят сами за себя

**Было (конец 2025):**
- 400 SMS/месяц
- Средняя цена: ~16₽ за SMS
- Месячные расходы: 6500-7000₽
- Годовые расходы: ~78 000₽
- Отправитель: случайный (INFO, NOTIFY)
- Доставка: не гарантирована
- Контроль: минимальный

**Стало (2026):**
- 400 SMS/месяц
- Тариф Тинькофф Мобайл: 49₽/месяц (безлимитные SMS)
- Месячные расходы: 49₽
- Годовые расходы: 588₽
- Отправитель: наш номер (клиенты могут перезвонить)
- Доставка: полный контроль и статусы
- Данные: вся история в собственной БД

**Экономия: 77 412₽ в год**

Это не просто цифра в Excel. Это почти зарплата сотрудника на полставки. Или новый стенд для ремонта. Или маркетинговая кампания.

### Дополнительные преимущества

**Контроль данных.** Вся история сообщений хранится в нашей базе данных навсегда. Можем в любой момент поднять статистику, построить аналитику, найти конкретное сообщение клиенту из прошлого года.

**Гибкость интеграции.** REST API позволяет интегрировать отправку SMS куда угодно. Планируем подключить к 1С — это будет несколько строк кода. Можно триггерить отправку из любых бизнес-процессов.

**Независимость.** Операторы меняют правила? Поднимают цены? Вводят новые ограничения? Нас это больше не касается. Мы контролируем весь процесс.

**Двусторонняя связь.** Бонус, о котором не думал изначально: клиенты могут ответить на SMS или позвонить. Android-устройство может принимать входящие сообщения, и мы можем обрабатывать их через API.

## Эпилог: кто платит за государственный SMS-спам

Пока писал эту статью, получил очередное сообщение от МЧС. На этот раз про возможную угрозу от беспилотников. Перед этим приходили уведомления про похолодание до -15°C (зима в Костроме, ничего необычного), про гололед, про сильный ветер.

*[Здесь будут скриншоты СМС от МЧС]*

Давайте посчитаем стоимость такой рассылки:
- Костромская область: ~630 000 населения
- Примерно 60% имеют мобильные телефоны: ~380 000 абонентов
- Среднее сообщение от МЧС: 2-3 SMS-части (>140 символов)
- Стоимость для агрегаторов: ~5-6₽ за полное сообщение
- **Одна рассылка: 380 000 × 6₽ = 2 280 000₽**

А таких рассылок за зиму может быть 10-15. Только на Кострому. А ведь есть еще 84 региона.

Интересно, правда? Малому бизнесу операторы говорят: платите 7000₽ в месяц за абонплату плюс до 50₽ за SMS. Государству: отправляйте миллионы сообщений, разберемся как-нибудь. От этих SMS, кстати, отписаться нельзя — они не регулируются ФЗ "О рекламе".

Может, рост цен для бизнеса — это просто способ компенсировать операторам "бесплатные" государственные рассылки? Кто-то ведь должен оплачивать эту инфраструктуру. И этот "кто-то", судя по всему, владельцы сервисных центров и интернет-магазинов.

## Заключение

Compaund-sms-gateway работает в продакшене уже несколько месяцев. За это время не было ни одного серьезного сбоя. Android-устройство надежно отправляет сообщения, PostgreSQL хранит всю историю, API справляется с нагрузкой.

Иногда лучшее решение — это не самое сложное, а самое подконтрольное. Когда индустрия превращается в абсурд с ценами по 50₽ за SMS, остается только одно: взять старый смартфон, написать пару сотен строк кода и вернуть контроль над процессом.

77 000₽ экономии в год — это не просто цифра. Это доказательство того, что иногда DIY — это не хобби энтузиаста, а форма экономической самообороны.