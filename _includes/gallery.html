{% comment %}
Image gallery component with navigation buttons
Usage: 
{% include gallery.html images=gallery_test id="gallery_test" %}
or
{% include gallery.html images=gallery_test %} (auto-generated ID)
{% endcomment %}

{% if include.id %}
  {% assign gallery_id = include.id %}
{% else %}
  {% assign gallery_id = 'gallery-' | append: forloop.index0 | append: '-' | append: page.date | date: "%Y%m%d" %}
{% endif %}

<div class="image-gallery" data-gallery-id="{{ gallery_id }}">
  {% assign lines = include.images | strip | split: "
" %}
  {% assign image_count = 0 %}
  {% for line in lines %}
    {% assign trimmed_line = line | strip %}
    {% unless trimmed_line == "" %}
      {% assign image_count = image_count | plus: 1 %}
    {% endunless %}
  {% endfor %}
  
  <div class="image-gallery-inner" data-count="{{ image_count }}">
    {% for line in lines %}
      {% assign trimmed_line = line | strip %}
      {% unless trimmed_line == "" %}
        {% assign parts = trimmed_line | split: "|" %}
        {% assign image_path = parts[0] | strip %}
        {% assign image_alt = parts[1] | strip | default: "" %}
        <img src="{{ image_path }}" alt="{{ image_alt }}" loading="lazy">
      {% endunless %}
    {% endfor %}
  </div>
  
  {% if image_count > 1 %}
  <div class="gallery-controls">
    <button class="gallery-nav gallery-nav-prev" data-gallery="{{ gallery_id }}" aria-label="Предыдущее изображение">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    </button>
    <button class="gallery-nav gallery-nav-next" data-gallery="{{ gallery_id }}" aria-label="Следующее изображение">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </button>
  </div>
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize gallery navigation for the specific gallery
  const galleryId = '{{ gallery_id }}';
  const gallery = document.querySelector('[data-gallery-id="' + galleryId + '"]');
  
  if (!gallery) {
    console.log('Gallery not found:', galleryId);
    return;
  }
  
  const scrollContainer = gallery.querySelector('.image-gallery-inner');
  const prevBtn = gallery.querySelector('.gallery-nav-prev[data-gallery="' + galleryId + '"]');
  const nextBtn = gallery.querySelector('.gallery-nav-next[data-gallery="' + galleryId + '"]');
  
  if (!scrollContainer || !prevBtn || !nextBtn) {
    console.log('Gallery elements not found for:', galleryId);
    return;
  }
  
  console.log('Gallery initialized:', galleryId);
  
  // Update button states based on scroll position
  function updateButtonStates() {
    const scrollLeft = scrollContainer.scrollLeft;
    const scrollWidth = scrollContainer.scrollWidth;
    const clientWidth = scrollContainer.clientWidth;
    
    // Check if at start (with small threshold)
    const atStart = scrollLeft <= 5;
    const atEnd = scrollLeft + clientWidth >= scrollWidth - 5;
    
    prevBtn.disabled = atStart;
    nextBtn.disabled = atEnd;
    
    // Visual feedback
    prevBtn.style.opacity = atStart ? '0.3' : '1';
    nextBtn.style.opacity = atEnd ? '0.3' : '1';
  }
  
  // Get image width for scrolling
  function getImageWidth() {
    const firstImage = scrollContainer.querySelector('img');
    if (!firstImage) return scrollContainer.clientWidth;
    
    const imageRect = firstImage.getBoundingClientRect();
    const containerRect = scrollContainer.getBoundingClientRect();
    const gap = 8; // 0.5rem gap between images
    
    return imageRect.width + gap;
  }
  
  // Scroll to next/previous image
  function scrollToDirection(direction) {
    const imageWidth = getImageWidth();
    const currentScroll = scrollContainer.scrollLeft;
    
    let targetScroll;
    if (direction === 'next') {
      targetScroll = currentScroll + imageWidth;
    } else {
      targetScroll = currentScroll - imageWidth;
    }
    
    // Ensure we don't scroll beyond bounds
    targetScroll = Math.max(0, Math.min(targetScroll, scrollContainer.scrollWidth - scrollContainer.clientWidth));
    
    scrollContainer.scrollTo({
      left: targetScroll,
      behavior: 'smooth'
    });
  }
  
  // Event listeners
  prevBtn.addEventListener('click', function(e) {
    e.preventDefault();
    if (!prevBtn.disabled) {
      scrollToDirection('prev');
    }
  });
  
  nextBtn.addEventListener('click', function(e) {
    e.preventDefault();
    if (!nextBtn.disabled) {
      scrollToDirection('next');
    }
  });
  
  // Throttle scroll events
  let scrollTimeout;
  scrollContainer.addEventListener('scroll', function() {
    if (scrollTimeout) {
      clearTimeout(scrollTimeout);
    }
    scrollTimeout = setTimeout(updateButtonStates, 50);
  });
  
  // Initial state
  updateButtonStates();
  
  // Update on window resize
  let resizeTimeout;
  window.addEventListener('resize', function() {
    if (resizeTimeout) {
      clearTimeout(resizeTimeout);
    }
    resizeTimeout = setTimeout(updateButtonStates, 100);
  });
  
  // Update when images load
  const images = scrollContainer.querySelectorAll('img');
  images.forEach(function(img) {
    img.addEventListener('load', updateButtonStates);
  });
});
</script>